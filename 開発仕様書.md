# 体重記録LINE Bot 開発仕様書

## プロジェクト概要
パーソナルトレーナー向けの体重記録システム。LINEで簡単に体重を記録し、Googleスプレッドシートに保存。継続を重視したシンプルな設計。

## システム構成
- **バックエンド**: Node.js + Express
- **LINE連携**: LINE Messaging API
- **データ保存**: Google Sheets API
- **スケジューラー**: node-cron
- **ダッシュボード**: HTML + Chart.js（Phase 2でReact化予定）

## 機能仕様

### 1. 初回登録フロー
```
ユーザー: 友達追加
Bot: 挨拶メッセージ送信
     「以下の4つの情報を教えてください：
      1. 目標体重（kg）
      2. 現在の体重（kg）  
      3. 身長（cm）
      4. 起床時間（例: 6:30）」
      
ユーザー: 「目標体重: 65
          現在の体重: 70
          身長: 170
          起床時間: 6:30」
          
Bot: 設定完了メッセージ + 初回の応援メッセージ
```

### 2. 毎日の記録フロー
```
Bot: [起床時間] おはようメッセージ + 体重入力促し
ユーザー: 体重の数値を送信（例: 69.5）
Bot: 記録完了 + 週平均 + 応援メッセージ

※未記録の場合
Bot: [20:00] リマインダーメッセージ送信
```

### 3. 応援メッセージロジック
- 目標まで10kg以上: 「一歩ずつ確実に進みましょう💪」
- 目標まで5-10kg: 「順調に近づいています🎯」
- 目標まで5kg未満: 「もう少しです✨」
- 目標達成: 「おめでとうございます！目標達成です🎉」

### 4. データ記録仕様
**Googleスプレッドシート形式**:
| 日付 | 時刻 | ユーザーID | 体重(kg) |
|------|------|------------|----------|
| 2025/1/15 | 6:35:00 | U123... | 69.5 |

## ディレクトリ構造
```
weight-tracking-bot/
├── src/
│   ├── index.js          # メインサーバー
│   ├── config/
│   │   └── line.js       # LINE設定
│   ├── services/
│   │   ├── lineBot.js    # LINEメッセージ処理
│   │   ├── sheets.js     # Google Sheets連携
│   │   └── scheduler.js  # Cronジョブ
│   ├── utils/
│   │   ├── messages.js   # メッセージテンプレート
│   │   └── calculations.js # 計算ロジック
│   └── data/
│       └── userStore.js  # ユーザーデータ管理
├── dashboard/
│   └── index.html        # ダッシュボード
├── .env                  # 環境変数
├── .gitignore
├── credentials.json      # Google認証情報
├── package.json
└── README.md
```

## 環境変数（.env）
```
# LINE設定
LINE_CHANNEL_ACCESS_TOKEN=your_channel_access_token_here
LINE_CHANNEL_SECRET=your_channel_secret_here

# Google Sheets設定
GOOGLE_SHEET_ID=your_spreadsheet_id_here

# サーバー設定
PORT=3000
NODE_ENV=development
```

## 必要なパッケージ（package.json）
```json
{
  "name": "weight-tracking-bot",
  "version": "1.0.0",
  "description": "体重記録LINE Bot",
  "main": "src/index.js",
  "scripts": {
    "start": "node src/index.js",
    "dev": "nodemon src/index.js",
    "test": "jest"
  },
  "dependencies": {
    "express": "^4.18.0",
    "@line/bot-sdk": "^7.5.0",
    "node-cron": "^3.0.0",
    "googleapis": "^105.0.0",
    "dotenv": "^16.0.0"
  },
  "devDependencies": {
    "nodemon": "^2.0.0",
    "jest": "^29.0.0"
  }
}
```

## セットアップ手順

### 1. LINE Developers設定
1. https://developers.line.biz/ にアクセス
2. プロバイダー作成 → チャンネル作成（Messaging API）
3. 以下を取得：
   - Channel Secret
   - Channel Access Token（長期）
4. Webhook URL設定: `https://your-domain.com/webhook`
5. Webhook利用: ON
6. 応答メッセージ: OFF

### 2. Google Cloud設定
1. https://console.cloud.google.com/ でプロジェクト作成
2. 「APIとサービス」→「ライブラリ」→ Google Sheets API有効化
3. 「認証情報」→「サービスアカウント作成」
4. JSON形式の認証情報をダウンロード → `credentials.json`として保存
5. Googleスプレッドシート作成
6. サービスアカウントのメールアドレスに編集権限付与

### 3. ローカル開発環境
```bash
# プロジェクト作成
mkdir weight-tracking-bot
cd weight-tracking-bot

# 初期化
npm init -y

# パッケージインストール
npm install express @line/bot-sdk node-cron googleapis dotenv
npm install -D nodemon jest

# 環境変数設定
cp .env.example .env
# .envファイルを編集

# 開発サーバー起動
npm run dev
```

### 4. ngrokでローカルテスト
```bash
# ngrokインストール後
ngrok http 3000

# 発行されたHTTPS URLをLINE DevelopersのWebhook URLに設定
```

## デプロイオプション

### Option 1: Heroku
```bash
# Heroku CLI必要
heroku create your-app-name
heroku config:set LINE_CHANNEL_ACCESS_TOKEN=xxx
heroku config:set LINE_CHANNEL_SECRET=xxx
heroku config:set GOOGLE_SHEET_ID=xxx
git push heroku main
```

### Option 2: Google Cloud Run
```dockerfile
# Dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
CMD ["node", "src/index.js"]
```

```bash
gcloud run deploy weight-tracking-bot \
  --source . \
  --platform managed \
  --region asia-northeast1 \
  --allow-unauthenticated
```

### Option 3: AWS Lambda
- Serverless Frameworkを使用
- API Gateway + Lambda構成

## データベース移行（将来）
現在: Map（メモリ）→ 将来: PostgreSQL or MongoDB

```sql
-- PostgreSQL スキーマ例
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    line_user_id VARCHAR(255) UNIQUE NOT NULL,
    goal_weight DECIMAL(5,2),
    current_weight DECIMAL(5,2),
    height DECIMAL(5,2),
    wake_time TIME,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE weight_records (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    weight DECIMAL(5,2) NOT NULL,
    recorded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## テスト項目
- [ ] 初回登録フロー
- [ ] 体重記録（正常値）
- [ ] 体重記録（異常値）
- [ ] 起床時間リマインダー
- [ ] 夜のリマインダー
- [ ] 週平均計算
- [ ] Googleスプレッドシート記録
- [ ] エラーハンドリング

## 今後の拡張予定
1. **Phase 2**: Reactダッシュボード
2. **Phase 3**: マクロ栄養素記録
3. **Phase 4**: パーソナルトレーニング予約システム統合

## 注意事項
- ユーザーデータのプライバシー保護
- LINE Messaging APIの利用制限（1000通/分）
- Google Sheets APIの利用制限（100リクエスト/100秒）
- タイムゾーンはJST固定